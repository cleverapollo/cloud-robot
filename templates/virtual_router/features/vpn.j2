connections {
{% for vpn in vpns %}

{# Section for an IKE connection named <conn> #}
    {{ project_id }}-{{ vpn['id'] }} {

{# IKE major version to use for connection. #}
        version = {{ vpn['version'] }}
        aggressive = {{ vpn['aggressive'] }}
        proposals = {{ vpn['ike_encryption_map'] }}-{{ vpn['ike_authentication_map'] }}-{{ vpn['ike_dh_groups_map'] }}
        over_time = {{ vpn['ike_lifetime'] }}s

{# Local address(es) to use for IKE communication, comma separated. #}
        local_addrs = {{ podnet_cpe }}
{# Remote address(es) to use for IKE communication, comma separated. #}
        remote_addrs = {{ vpn['ike_gateway_value'] }}
{# Default inbound XFRM interface ID for children. #}
        if_id_in = {{ vpn['stif_number'] }}
{# Default outbound XFRM interface ID for children. #}
        if_id_out = {{ vpn['stif_number'] }}

{# Section for a local authentication round. #}
        local {
            auth = psk
            id = {{ vpn['id'] }}
        }
{# Section for a remote authentication round, %any considers an integer or an IP address #}
        remote {
            auth = psk
            id = %any
        }

{# CHILD_SAs configuration sub-section. #}
        children {
{% for child_sa in vpn['child_sas'] %}
            {{ project_id }}-{{ vpn['id'] }}-{{ loop.index }} {
                life_time = {{ vpn['ipsec_lifetime'] }}s
{# Local traffic selectors to include in CHILD_SA. #}
                local_ts = {{ child_sa['lts'] }}
                esp_proposals = {{ vpn['ipsec_encryption_map'] }}-{{ vpn['ipsec_authentication_map'] }}-{{ vpn['ipsec_pfs_groups_map'] }}
{# Remote selectors to include in CHILD_SA. #}
                remote_ts = {{ child_sa['rts'] }}
{# Inbound XFRM interface ID. #}
                if_id_in = {{ vpn['stif_number'] }}
{# Outbound XFRM interface ID. #}
                if_id_out = {{ vpn['stif_number'] }}
{# IPSec Establish time. #}
                start_action = {{ vpn['start_action'] }}
            }
{% endfor %}
        }
    }
{% endfor %}
}

secrets {
{% for vpn in vpns %}
    ike{{ vpn['id'] }} {
{# Value of the IKE preshared secret. #}
        secret = {{ vpn['ike_pre_shared_key'] }}
{# IKE identity the IKE preshared secret belongs to. #}
        id = {{ vpn['id'] }}
    }
{% endfor %}
}
